<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <link rel="stylesheet" href="/styles/style.css" />
    <link rel="icon" href="/favicon.ico">
    <script src="https://cdn.jsdelivr.net/gh/papnkukn/qrcode-svg/dist/qrcode.min.js"></script>
    <title>Rolodex App</title>
    <style>
      body {
        background-color: #0f172a;
        color: #f8fafc;
        font-family: Arial, sans-serif;
      }
      .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 2rem;
      }
      #welcomeMessage {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 1rem;
      }
      #communityCountMessage {
        font-size: 1.5rem;
        margin-bottom: 2rem;
      }
      #communityList {
        width: 100%;
        max-width: 400px;
      }
      .community-item {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        background-color: #1e293b;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .community-item:hover {
        background-color: #2d3748;
      }
      .community-info {
        display: flex;
        align-items: center;
      }
      .community-image {
        width: 3rem;
        height: 3rem;
        border-radius: 50%;
        margin-right: 1rem;
        
      }
      .community-name {
        font-size: 1.25rem;
        font-weight: 600;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000; /* Increase z-index to ensure it's on top */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
      }
      .modal-content {
        background-color: #1e293b;
        margin: 15% auto;
        padding: 20px;
        border-radius: 0.5rem;
        width: 80%;
        max-width: 500px;
        position: relative; /* Add this */

      }
      .modal-header {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
      }
      .modal-header img {
        width: 4rem;
        height: 4rem;
        border-radius: 50%;
        margin-right: 1rem;
      }
      .modal-header h2 {
        font-size: 1.5rem;
        font-weight: bold;
      }
      .modal-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 1rem;
      }
      .btn {
        background-color: #3b82f6;
        color: white;
        border: none;
        border-radius: 0.25rem;
        padding: 0.5rem 1rem;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .btn:hover {
        background-color: #2563eb;
      }
      .footer {
        margin-top: 2rem;
        font-size: 0.875rem;
        color: #64748b;
      }
    </style>
  </head>

  <%- include('../partials/google_analytics.ejs') %>

  

    <script type="module">
    import { account, portOldContacts, addContact, getContacts, getContactByUID, editContact, deleteContact, filterContacts,
        getProfile, updateProfile, signout, importContacts, appleCredsPresent, importGoogleContacts, downloadContactsDataLocally, getMembers,getCommunityMembers, uint8arrays, getFidFromAccountDID} from '/odd.js';
      window.addContact = addContact;
      window.getContacts = getContacts;
      window.editContact = editContact;
      window.deleteContact = deleteContact;
      window.filterContacts = filterContacts;
      window.updateProfile = updateProfile;
      window.signout = signout;
      window.importContacts = importContacts;
      window.importGoogleContacts = importGoogleContacts;
      window.downloadContactsDataLocally = downloadContactsDataLocally;
      window.getProfile = getProfile;
      window.getContactByUID = getContactByUID;
      window.appleCredsPresent = appleCredsPresent;
      window.getMembers = getMembers;
      window.uint8arrays = uint8arrays;
      var farcasterHandle;
      let communityMap = new Map();
      let communityCount = 0;

      window.openModal = function(community) {
        const modal = document.getElementById('communityModal');
        const modalImage = document.getElementById('modalImage');
        const modalCommunityName = document.getElementById('modalCommunityName');

        modalImage.src = community.PHOTO || 'https://via.placeholder.com/50';
        modalCommunityName.textContent = community.FN;
        modal.style.display = 'block';
    console.log("Modal display set to 'block'");
    console.log("Modal current display style:", window.getComputedStyle(modal).display);
      }

      window.followRandom = function() {
        console.log('Following 3 random people');
        // Implement the logic to follow 3 random people
      }

      window.followAll = function() {
        console.log('Following all people');
        // Implement the logic to follow all people
      }

      // Close the modal when clicking outside of it
      window.onclick = function(event) {
        const modal = document.getElementById('communityModal');
        if (event.target == modal) {
          modal.style.display = 'none';
        }
      }

      window.updateCommunityCount = function() {
        const countMessage = document.getElementById('communityCountMessage');
        countMessage.textContent = `You are part of ${communityCount} ${communityCount === 1 ? 'community' : 'communities'}`;
      }

      window.getListOfFidFromCommunityContact = async function(communityContact){
         console.log(communityContact);
         var communityDID = communityContact.UID;
         let community = await getContactByUID(communityDID);
         await getCommunityMembers(community);
        if (community.cache) {
          let fidArray = [];
          for (let member of community.cache.people) {
              let uid = member.UID;
              let fid = await getFidFromAccountDID(uid.slice(4)); //remove DCN 
              fidArray.push([fid.split('@')[0], null]); // get '123' from '123@farcaster'
          }
          console.log("fidArray", fidArray);
          console.log("community name",communityContact.FN );
          communityMap.set(communityContact.FN, fidArray);
        }
      }
     
      window.refreshContacts = async function(){
        const communityList = document.getElementById('communityList');
        communityList.innerHTML = ''; // Clear existing content

        window.getContacts().then((result) => {
          result.contactList.push(result.contactList[0])
          result.contactList.forEach((contact) => {
            if (contact.CATEGORIES === "community") {
              communityCount++;
              const communityName = contact.FN;
              const communityContainer = document.createElement('div');
              communityContainer.className = 'community-item';
              communityContainer.onclick = function() {
                console.log("community item clicked", contact);
                window.openModal(contact);
              }

              const communityInfo = document.createElement('div');
              communityInfo.className = 'community-info';

              const communityImage = document.createElement('img');
              communityImage.src = contact.PHOTO || 'https://via.placeholder.com/50';
              communityImage.alt = communityName;
              communityImage.className = 'community-image';

              const communityElement = document.createElement('span');
              communityElement.textContent = communityName;
              communityElement.className = 'community-name';

              communityInfo.appendChild(communityImage);
              communityInfo.appendChild(communityElement);
              communityContainer.appendChild(communityInfo);
              communityList.appendChild(communityContainer);

              getListOfFidFromCommunityContact(contact);
            }
          });

          updateCommunityCount();
        });
      }

      window.refreshProfile = function(){
        window.getProfile().then((result) => {
          console.log("profile is", result);
          const welcomeMessage = document.getElementById('welcomeMessage');
          welcomeMessage.textContent = `Welcome ${result.handle}`;
          welcomeMessage.style.display = 'block';
        });
      }

      

      await refreshContacts();
      refreshProfile();
    </script>
    <body class="antialiased">
      <div class="container">
        <div id="welcomeMessage" style="display: none;">Welcome</div>
        <div id="communityCountMessage"></div>
        <div id="communityList"></div>
        <div id="communityModal" class="modal">
          <div class="modal-content">
            <span class="close">&times;</span>
            <div class="modal-header">
              <img id="modalImage" src="" alt="Community Image">
              <h2 id="modalCommunityName"></h2>
            </div>
            <div class="modal-buttons">
              <button class="btn" onclick="followRandom()">Follow 3 Random People</button>
              <button class="btn" onclick="followAll()">Follow All</button>
            </div>
          </div>
        </div>
        <%- include('../partials/shovel.ejs') %>
      </div>
  </body>
</html>